# 跨切面模式：三层经验管理（Experience Management）

> 将 `context/experience/` 的目录结构升级为可检索、可沉淀的管理模式。

## 概述

三层经验管理模式将经验知识组织为**索引层 → 文档层 → 摘要层**的三层结构，配合相关度计算和自动沉淀机制，实现经验的高效复用。

### 与现有 context/experience/ 的关系

```
现有 context/experience/：
  提供了目录结构（INDEX.md + lessons/ + reports/）
  ↓ 经验管理模式增值
  索引可检索 → 相关度排序 → 自动沉淀
```

经验管理模式不改变现有目录结构，而是增加使用策略和自动化机制。

## 三层架构

### 第一层：索引层（Index）

**文件**：`context/experience/INDEX.md`

索引层是经验的**入口和导航**，提供快速检索能力。

**格式要求**：

```markdown
# 经验索引

## 按领域分类

### 认证与安全
| 关键词 | 文档 | 摘要 |
|--------|------|------|
| auth, login, OAuth, JWT | [auth-token-refresh.md](lessons/auth-token-refresh.md) | Token 刷新需考虑并发场景 |
| password, reset, 密码 | [auth-password-reset.md](lessons/auth-password-reset.md) | 重置 Token 必须有过期时间 |

### 数据库
| 关键词 | 文档 | 摘要 |
|--------|------|------|
| migration, schema, 迁移 | [db-migration-safety.md](lessons/db-migration-safety.md) | 大表 migration 必须分批执行 |
```

**关键设计**：
- 每条索引包含**关键词**（支持中英文）、**文档链接**、**一句话摘要**
- 按领域分组，便于人工浏览
- 关键词支持模糊匹配

### 第二层：文档层（Documents）

**目录**：`context/experience/lessons/`

文档层存储**完整的经验记录**，包含问题描述、解决方案、影响评估。

**模板**：

```markdown
# 经验：{标题}

## 问题
# 遇到了什么问题

## 原因
# 根本原因分析

## 解决方案
# 如何解决的

## 影响
# 影响范围和程度

## 预防措施
# 如何避免再次发生

## 元信息
- 日期：YYYY-MM-DD
- 领域：{domain}
- 严重性：{low | medium | high | critical}
- 关键词：{keyword1, keyword2, ...}
```

### 第三层：摘要层（Summaries）

**目录**：`context/experience/summaries/`（可选）

摘要层为**高频领域**提供聚合摘要，避免 AI 需要加载大量单独文档。

**格式**：

```markdown
# 领域摘要：{领域名}

## 核心教训（Top 5）

1. **{教训 1}**：{一句话描述}
2. **{教训 2}**：{一句话描述}
...

## 常见陷阱

- {陷阱 1}
- {陷阱 2}

## 推荐实践

- {实践 1}
- {实践 2}
```

**触发摘要生成的条件**：某领域累计 ≥ 5 条经验时，建议生成摘要。

## 相关度计算

当 AI 执行任务时，从索引中检索相关经验的算法：

### 评分模型

```
相关度 = 关键词匹配(40%) + 领域匹配(30%) + 任务类型匹配(30%)
```

| 维度 | 权重 | 计算方式 |
|------|------|---------|
| 关键词匹配 | 40% | 任务描述中包含索引关键词的比例 |
| 领域匹配 | 30% | 任务涉及的领域与经验领域是否一致 |
| 任务类型匹配 | 30% | 任务类型（新功能/修复/重构）与经验类型是否匹配 |

### 阈值

| 相关度 | 行为 |
|--------|------|
| ≥ 0.7 | **强相关**：自动加载完整经验文档 |
| 0.4 - 0.7 | **可能相关**：展示摘要，询问是否加载 |
| < 0.4 | **不相关**：不加载 |

### 示例

```
任务："添加用户密码重置功能"

关键词提取：password, reset, 密码, 重置, 用户
领域推断：认证与安全
任务类型：新功能

索引匹配：
  auth-password-reset.md
    关键词匹配：password(✓) reset(✓) 密码(✓) → 3/5 = 0.6 → × 0.4 = 0.24
    领域匹配：认证与安全 = 认证与安全 → 1.0 → × 0.3 = 0.30
    类型匹配：新功能 vs 经验(修复) → 0.5 → × 0.3 = 0.15
    总分：0.69 → 可能相关，展示摘要

  auth-token-refresh.md
    关键词匹配：无直接匹配 → 0/5 = 0.0 → × 0.4 = 0.00
    领域匹配：认证与安全 = 认证与安全 → 1.0 → × 0.3 = 0.30
    类型匹配：新功能 vs 经验(修复) → 0.5 → × 0.3 = 0.15
    总分：0.45 → 可能相关，展示摘要
```

## 自动沉淀机制

### 触发条件

任务完成后，AI 应评估是否需要沉淀经验：

| 信号 | 沉淀优先级 |
|------|-----------|
| 任务中遇到了意外问题 | 高 |
| 使用了非显而易见的解决方案 | 高 |
| 发现了文档未覆盖的边界情况 | 中 |
| 任务耗时超过预期 | 中 |
| 任务顺利完成，无特殊情况 | 低（不沉淀） |

### 沉淀流程

```
任务完成 → 评估沉淀价值 → 生成经验草稿 → 更新索引 → 人工确认（可选）
```

### 索引更新规则

新经验沉淀后，自动追加到 INDEX.md 的对应领域分组下。如果领域不存在，创建新分组。

## 实施指南

### 最小实现

1. 在 `context/experience/INDEX.md` 中按上述格式建立索引
2. 在 AGENTS.md 的"经验自动检索"部分引用本模式的相关度计算规则
3. 每次任务后评估是否需要沉淀

### 渐进采纳

| 级别 | 实现方式 | 适用场景 |
|------|---------|---------|
| 基础 | INDEX.md 手动维护 + 关键词匹配 | L1 项目 |
| 进阶 | 相关度评分 + 自动沉淀建议 | L2 项目 |
| 完整 | 三层结构 + 摘要生成 + 自动沉淀 | L3 项目 |

## 与其他模式的协作

- **阶段路由模式**：Phase Router 在 implement 阶段前触发经验检索
- **上下文加载模式**：经验是 5 层上下文中的第 3 层（经验层）

## 参考

- [context/experience/INDEX.md](../../context/experience/INDEX.md) — 经验索引
- [context/experience/lessons/_template.md](../../context/experience/lessons/_template.md) — 经验文档模板
- [上下文加载模式](context-loading.md) — 上下文加载策略
